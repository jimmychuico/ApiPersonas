#cloud-config
package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - apt-transport-https

runcmd:
  - curl -fsSL https://get.docker.com | sh
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker azureuser

  - docker pull mcr.microsoft.com/mssql/server:2022-latest
  - docker pull jimmydoc1/apipersonas:latest

  - docker run -d \
      --name sqlserver \
      -e ACCEPT_EULA=Y \
      -e SA_PASSWORD=StrongPassword123! \
      -p 1433:1433 \
      mcr.microsoft.com/mssql/server:2022-latest

  - sleep 30

  - docker run -d \
      --name apipersonas \
      -p 8081:8080 \
      -e ConnectionStrings__DefaultConnection=Server=localhost;Database=PersonaDb;User Id=sa;Password=StrongPassword123!;TrustServerCertificate=True \
      jimmydoc1/apipersonas:latest
